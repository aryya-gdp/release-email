name: Send Release Email

on:
  workflow_run:
    workflows: ["Build Binary"]
    types:
      - completed

jobs:
  send-email:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch release info
        id: release
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          echo "TAG=$TAG" >> $GITHUB_ENV

          echo "Getting release info for $TAG..."

          # Get release JSON from GitHub API
          gh api repos/${{ github.repository }}/releases/tags/$TAG > release.json

          # Extract fields
          echo "RELEASE_TITLE=$(jq -r '.name // "No Title"' release.json)" >> $GITHUB_ENV

          {
            echo 'RELEASE_BODY_HTML<<EOF'
            jq -r '.body_html // "<p>No description provided.</p>"' release.json
            echo 'EOF'
          } >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send release email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ vars.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "🚀 New Release: ${{ env.RELEASE_TITLE }}"
          to: ${{ vars.SMTP_TO }}
          from: Release Bot <${{ vars.SMTP_FROM }}>
          content_type: text/html
          body: |
            <p>🚀 A new release has been published</p>

            <h3>🔖 Title</h3>
            <p><b>${{ env.RELEASE_TITLE }}</b></p>

            <h3>📝 Description</h3>
            <div style="font-family: sans-serif; line-height: 1.5;">
              ${{ env.RELEASE_BODY_HTML }}
            </div>

            <p><b>📌 Full Changelog:</b>
            <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG }}">
              View on GitHub
            </a></p>
