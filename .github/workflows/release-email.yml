name: Send Release Email

on:
  workflow_run:
    workflows: ["Build Binary"]
    types:
      - completed

jobs:
  send-email:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch release info
        id: release
        run: |
          TAG="${{ github.event.workflow_run.head_branch }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
      
          echo "Getting release info for $TAG..."
          gh release view "$TAG" --json name,body > release.json || echo "{}" > release.json
      
          {
            echo 'RELEASE_TITLE<<EOF'
            jq -r '.name // "No Title"' release.json
            echo 'EOF'
      
            echo 'RELEASE_BODY<<EOF'
            jq -r '.body // "No description provided."' release.json
            echo 'EOF'
          } >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Convert release body to HTML
        run: |
          echo "${{ env.RELEASE_BODY }}" > release_body.md
          sudo apt-get install -y pandoc
          pandoc -f markdown -t html release_body.md -o release_body.html
          {
            echo 'RELEASE_BODY_HTML<<EOF'
            cat release_body.html
            echo 'EOF'
          } >> $GITHUB_ENV

      - name: Send release email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ vars.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ğŸš€ New Release: ${{ env.RELEASE_TITLE }}"
          to: ${{ vars.SMTP_TO }}
          from: Release Bot <${{ vars.SMTP_FROM }}>
          content_type: text/html
          body: |
            <p>ğŸš€ A new release has been published</p>

            <h3>ğŸ”– Title</h3>
            <p><b>${{ env.RELEASE_TITLE }}</b></p>

            <h3>ğŸ“ Description</h3>
            <div style="white-space: pre-wrap; font-family: sans-serif;">
            ${{ env.RELEASE_BODY_HTML }}
            </div>

            <p><b>ğŸ“Œ Full Changelog:</b>
            <a href="https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG }}">
              View on GitHub
            </a></p>
